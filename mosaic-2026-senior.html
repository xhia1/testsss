<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WRO 2026 Senior - Mosaic Paper Randomizer (3x4)</title>
  <style>
    :root{
      --font: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;

      /* グリッドの実寸 */
      --cell: 34mm;
      --gap: 16mm;
    }
    body{ margin:0; font-family:var(--font); background:#fafafa; color:#111; }
    header{ background:#fff; border-bottom:1px solid #e5e5e5; }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    header .wrap{ display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center; }

    h1{ margin:0; font-size:16px; }

    .btn, select, input{
      padding:10px 12px; border-radius:12px; border:1px solid #ccc;
      background:#fff; font-weight:900;
    }
    .btn{ cursor:pointer; }
    .btn:hover{ background:#f2f2f2; }
    input{ font-weight:800; }

    .bar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* 印刷対象：サイズはJSでstyle.width/heightをセット */
    .paper{
      background:#fff;
      box-sizing:border-box;
      border: 2px solid #000; /* 黒枠込み運用 */
      position: relative;
      margin-top: 14px;
      overflow: hidden;
    }

    /* 上向きマーク */
    .arrow{
      position:absolute; top:6mm; left:6mm;
      font-weight:900; font-size:12px;
      background:#fff; padding:2px 6px; border:1px solid #000; border-radius:8px;
    }

    /* 4×3（横4 / 縦3）を中央に配置 */
    .grid{
      position:absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      display:grid;
      grid-template-columns: repeat(4, var(--cell));
      grid-template-rows: repeat(3, var(--cell));
      column-gap: var(--gap);
      row-gap: var(--gap);
      transform-origin: center;
    }
    .cell{
      width: var(--cell);
      height: var(--cell);
      border: 1px solid #000;
      box-sizing:border-box;
    }

    .note{
      margin-top:10px; font-size:12px; color:#333; line-height:1.6;
    }
    .tiny{
      font-size:12px; color:#444; font-weight:700;
    }

    @media print{
      body{ background:#fff; }
      header, .note { display:none; }
      .wrap{ padding:0; max-width:none; }
      .paper{ margin:0; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>RoboMission 2026 Senior — Mosaic Paper Randomizer (3×4)</h1>
    <div class="bar">
      <select id="size" aria-label="paper size">
        <option value="190x150">190×150mm (DE)</option>
        <option value="184x134" selected>184×134mm (true 34/16 scale)</option>
        <option value="183x134">183×134mm (alt / 1mm diff)</option>
      </select>

      <input id="seed" type="text" placeholder="Seed (例: R1)" aria-label="seed" />

      <button class="btn" id="gen">neue Anordnung</button>
      <button class="btn" id="cap">Download PNG</button>
      <button class="btn" id="print">Print</button>
      <button class="btn" id="copylink">Copy Link</button>
      <button class="btn" onclick="location.href='./index.html'">Back</button>

      <span class="tiny" id="status"></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="paper" class="paper" aria-label="print paper">
    <div class="arrow">↑ TOP</div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="note">
    ・印刷は「拡大縮小なし（100%）」推奨。まず定規で 34mm（色マス）と 16mm（間隔）を確認。<br>
    ・12マスは 4色×各3個で均等。Seedを入れると同じ配置を再現できます（URL共有可）。<br>
    ・紙でモザイク配置をランダム化する運用は公式ルールの想定です。:contentReference[oaicite:1]{index=1}
  </div>
</div>

<script>
  const COLORS = [
    { key:"Y", hex:"#ffd400" }, // yellow
    { key:"B", hex:"#2f6bff" }, // blue
    { key:"G", hex:"#21b35b" }, // green
    { key:"W", hex:"#ffffff" }, // white
  ];

  // --- seeded RNG ---
  function xfnv1a(str){
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return () => {
      h += h<<13; h ^= h>>>7;
      h += h<<3;  h ^= h>>>17;
      h += h<<5;
      return h>>>0;
    };
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t>>>15), t | 1);
      t ^= t + Math.imul(t ^ (t>>>7), t | 61);
      return ((t ^ (t>>>14))>>>0) / 4294967296;
    }
  }
  function makeRng(seedStr){
    if(!seedStr) return Math.random;
    const seed = xfnv1a(seedStr)();
    return mulberry32(seed);
  }
  function shuffle(arr, rng){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // 12マス = 4色×各3個
  function generate(seedStr){
    const each = 3;
    const bag = [];
    for(const c of COLORS){
      for(let i=0;i<each;i++) bag.push(c);
    }
    shuffle(bag, makeRng(seedStr));
    return bag;
  }

  function render(bag){
    const grid = document.getElementById("grid");
    grid.innerHTML = "";
    bag.forEach(c => {
      const div = document.createElement("div");
      div.className = "cell";
      div.style.background = c.hex;
      grid.appendChild(div);
    });
  }

  function parseSize(v){
    const [wmm,hmm] = v.split("x").map(Number);
    return { wmm, hmm };
  }

  function applyPaperSize(){
    const { wmm, hmm } = parseSize(document.getElementById("size").value);
    const paper = document.getElementById("paper");
    paper.style.width  = `${wmm}mm`;
    paper.style.height = `${hmm}mm`;
    return { wmm, hmm };
  }

  // 用紙に収まるようスケール（190×150でも必ず全表示）
  function fitGridToPaper(wmm, hmm){
    // 4×3 の本来サイズ（34/16）
    const gridW = 4*34 + 3*16; // 184
    const gridH = 3*34 + 2*16; // 134

    const s = Math.min(wmm / gridW, hmm / gridH, 1);

    const grid = document.getElementById("grid");
    grid.style.transform = `translate(-50%,-50%) scale(${s})`;
  }

  // URL sync: ?seed=R1&size=184x134
  function syncToUrl(){
    const seed = document.getElementById("seed").value.trim();
    const size = document.getElementById("size").value;
    const url = new URL(location.href);
    if(seed) url.searchParams.set("seed", seed);
    else url.searchParams.delete("seed");
    url.searchParams.set("size", size);
    history.replaceState(null, "", url.toString());
  }

  function loadFromUrl(){
    const url = new URL(location.href);
    const size = url.searchParams.get("size");
    const seed = url.searchParams.get("seed");

    if(size === "190x150" || size === "184x134" || size === "183x134"){
      document.getElementById("size").value = size;
    }
    if(seed){
      document.getElementById("seed").value = seed;
    }
  }

  function setStatus(text){
    document.getElementById("status").textContent = text;
  }

  function doGen(){
    const seed = document.getElementById("seed").value.trim();
    const { wmm, hmm } = applyPaperSize();
    fitGridToPaper(wmm, hmm);
    render(generate(seed));
    syncToUrl();
    setStatus(`size: ${wmm}×${hmm}mm / seed: ${seed || "random"} / grid: 3×4`);
  }

  // Download PNG: SVG foreignObject方式（外部ライブラリ不要）
  async function savePng(){
    const { wmm, hmm } = applyPaperSize();
    fitGridToPaper(wmm, hmm);

    const paper = document.getElementById("paper");

    // 96dpi換算
    const pxW = Math.round(wmm * 96 / 25.4);
    const pxH = Math.round(hmm * 96 / 25.4);

    const html = new XMLSerializer().serializeToString(paper);
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="${pxW}" height="${pxH}">
  <foreignObject width="100%" height="100%">
    <div xmlns="http://www.w3.org/1999/xhtml">${html}</div>
  </foreignObject>
</svg>`;

    const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.onload = () => {
      const cv = document.createElement("canvas");
      cv.width = pxW; cv.height = pxH;
      const ctx = cv.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,pxW,pxH);
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);

      const a = document.createElement("a");
      const seed = (document.getElementById("seed").value.trim() || "random").replace(/[^\w\-]+/g,"_");
      const size = document.getElementById("size").value;
      a.download = `mosaic_2026_senior_${seed}_${size}mm_3x4.png`;
      a.href = cv.toDataURL("image/png");
      a.click();
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert("PNG生成に失敗しました。Chrome/Edgeで試してください。");
    };
    img.src = url;
  }

  async function copyLink(){
    try{
      syncToUrl();
      await navigator.clipboard.writeText(location.href);
      alert("リンクをコピーしました");
    }catch{
      alert("コピーできませんでした（ブラウザ権限を確認）");
    }
  }

  // wiring
  document.getElementById("gen").addEventListener("click", doGen);
  document.getElementById("cap").addEventListener("click", savePng);
  document.getElementById("print").addEventListener("click", () => window.print());
  document.getElementById("copylink").addEventListener("click", copyLink);
  document.getElementById("size").addEventListener("change", doGen);

  // init
  loadFromUrl();
  doGen();
</script>
</body>
</html>
